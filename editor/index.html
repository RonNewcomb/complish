<html>
  <head>
    <title>Complish IDE</title>
    <meta name="Description" content="An online editor for Complish" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link rel="stylesheet" type="text/css" href="css/index.css" />
    <link rel="stylesheet" type="text/css" href="css/tooltips.css" />
    <link rel="stylesheet" type="text/css" href="css/parts-of-speech.css" />
  </head>

  <body>
    <main-menu></main-menu>

    <flex-row flex-wrap="nowrap">
      <titled-panel name="GLOSSARY" classes="leftsidebar"></titled-panel>
      <titled-panel name="THE TEXT" classes="">
        <div id="main"></div>
      </titled-panel>
    </flex-row>

    <script type="module">
      const worker = new Worker("./script/main.js", { type: "module" }); // modules in workers only for Chrome right now
      worker.onmessage = e => (document.getElementById("main").innerHTML = e.data);
      /* the "render once" UI framework */

      const loadHtml = element => Promise.allSettled(Array.from(element.children).map(child => (child.tagName.includes("-") ? load1Html : scan)(child)));

      const load1Html = el =>
        fetch("html/" + el.tagName + ".html")
          .then(response => response.text())
          .then(html => {
            if (html.match(/{{innerHTML}}/)) html = html.replace(/{{innerHTML}}/g, el.innerHTML);
            Array.from(el.attributes).forEach(attr => (html = html.replace(new RegExp("{{" + attr.name + "}}", "g"), attr.value)));
            el.innerHTML = html;
            const missingArgument = html.match(/{{[a-zA-Z-]+}}/);
            if (missingArgument) console.error("Missing argument for", missingArgument[0], "in", el.tagName);
          })
          .then(_ => loadHtml(el))
          .then(_ =>
            Array.from(el.querySelectorAll("script")).forEach(old => {
              const replacement = document.createElement("script");
              replacement.appendChild(document.createTextNode(old.innerHTML));
              old.replaceWith(replacement);
            })
          );

      loadHtml(document.body).then(_ => worker.postMessage("GO!"));
    </script>
  </body>
</html>
