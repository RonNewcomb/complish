<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Complish IDE</title>
    <meta charset="UTF-8" />
    <meta name="Description" content="An online editor for Complish" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link rel="stylesheet" type="text/css" href="css/index.css" />
    <link rel="stylesheet" type="text/css" href="css/tooltips.css" />
    <link rel="stylesheet" type="text/css" href="css/parts-of-speech.css" />
  </head>

  <body>
    <hello-world>Commander</hello-world>
    <button onclick="another()">Add new component instance</button>

    <!-- <script src="code/loader.js"></script> -->
    <script>
      function another() {
        document.body.insertAdjacentHTML("beforeend", "<hello-world>General</hello-world>");
      }
    </script>

    <main-menu></main-menu>

    <flex-row wrap="nowrap">
      <titled-panel name="GLOSSARY" classes="leftsidebar">
        <div id="glossary"></div>
      </titled-panel>
      <titled-panel name="THE TEXT" classes="">
        <div id="main"></div>
      </titled-panel>
    </flex-row>

    <for-each message='["foo","bar"]'>
      <div>{{message}}</div>
    </for-each>

    <modal-dialogs></modal-dialogs>

    <script type="module">
      import { findDefinitions, formatForDisplay } from "./code/find-definitions.js";

      /* worker */
      const worker = new Worker("./workers/main.js", { type: "module" }); // modules in workers only for Chrome right now
      const sendToWorker = message =>
        new Promise(resolve => {
          worker.onmessage = resolve;
          worker.postMessage(message);
        });

      /* the "render once" UI framework */

      const attach = (element, comp) => {
        console.log("Componanet", element.tagName, "template", comp.template.content);
        const shadow = element.attachShadow({ mode: "open" });
        shadow.appendChild(comp.style.cloneNode(true));
        shadow.appendChild(document.importNode(comp.template.content, true));
        Object.entries(comp.listeners).forEach(([event, listener]) => element.addEventListener(event, listener, false));
      };
      const loadHtmls = element => Promise.allSettled(Array.from(element.children).map(child => (child.tagName.includes("-") ? loadHtml : loadHtmls)(child)));
      const loadHtml = element =>
        fetch("html/" + element.tagName.replace(/--/g, "/") + ".html")
          .then(response => response.text())
          .then(html => new DOMParser().parseFromString(html, "text/html").head)
          .then(head => ({
            template: head.querySelector("template"),
            style: head.querySelector("style"),
            script: head.querySelector("script"),
          }))
          .then(async comp => {
            const blob = new Blob([comp.script.textContent || ""], { type: "application/javascript" });
            const url = URL.createObjectURL(blob);
            console.log("importing ", element.tagName, url);
            const module = await import(url).catch(console.error);
            console.log(element.tagName, "imported!");
            comp.listeners = Object.entries(module.default).reduce((listeners, [setting, value]) => {
              if (setting.startsWith("on")) listeners[setting[2].toLowerCase() + setting.substr(3)] = value;
              return listeners;
            }, {});
            return comp;
          })
          .then(comp =>
            customElements.define(
              element.tagName.toLowerCase(),
              class extends HTMLElement {
                connectedCallback() {
                  attach(this, comp);
                }
              }
            )
          );

      loadHtmls(document.body)
        .then(_ => sendToWorker("this should be the source code here"))
        .then(e => {
          document.getElementById("main").innerHTML = e.data;
          document.getElementById("glossary").innerHTML = formatForDisplay(findDefinitions());
        });
    </script>
  </body>
</html>
